<!DOCTYPE html>
<html lang="en">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="/featuresJSONObject"></script>
    <head>
        <title>Simple Map</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/index.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    </head>
    <body>
        <h1>Borg at work</h1>
        <div class="row">
            <div class = "col-sm-6 mapContainer">
                <div class="mapContainer" style="height:500px; width: 100%">
                    <div id="map"></div>
                </div>
            </div>
            <div class = "col-sm-6 formContainer">
                <h3 class="header"> Add new item </h3>
                <form id="featureForm">
                    <p> <label> Address: </label> <label class="address"/> </p>
                    <p> <label> Description: </label> <input type="text" name="description"  required="required" /> </p>
                    <p> <label> Photo: </label> <input type="file" name="photo" onchange="previewFile()">
                        <img class="previewImage" src="" height="50" alt="Image preview...">
                    </p>
                    <input type="hidden" name="googlePlaceId" />
                    <input type="hidden" name="latitude"/>
                    <input type="hidden" name="longitude"/>
                    <button type="button" onclick="submitFeature()" ng-click="submitsinethusfdsf()">SUBMIT</button>
                </form>
            </div>
            <script>
                var latlong = { lng: 19.937327, lat: 50.061769};

                var gmap, currMarker, placesService;
                var addressoText = "Go Fuck Yourself";
                var addressoWindow;
                var noPlaceSelected= "Please mark a valid address on the map";
                $("label.address").text(noPlaceSelected);
                var geocoder;
                function submitFeature(){
                    var fd = new FormData($('#featureForm')[0]);
                    var method = "PUT";
                    var url = "/feature/"; // + $(".googlePlaceId").get(0).value;
                    var request = {
                        url: url,
                        enctype: 'multipart/form-data',
                        type: method,
                        processData: false,  // tell jQuery not to process the data
                        contentType: false,  // tell jQuery not to set contentType
                        cache: false,
                        data: fd,
                        beforeSend: function (xhr) {
                        },
                        error: function(jqXHR) {

                            console.log("ajax error " + jqXHR.status);
                        },
                        success: function(jqXHR) {
                            alert ("SUCCESSS BITCHES >>> WE NO be Failed " +  jqXHR.status);
                        }
                    };
                    $.ajax(request);
                }
                function previewFile() {
                    var previewImage = document.querySelector('img.previewImage');
                    var file    = document.querySelector('input[name="photo"]').files[0];
                    var reader  = new FileReader();
                    reader.addEventListener("load", function () {
                        previewImage.src = reader.result;
                    }, false);
                    if (file) {
                        reader.readAsDataURL(file);
                    }
                }

                function loadInitialFeatures(){
                    /*Assumes featuresJSONObject already downloaded*/
                    featuresJSONObject.forEach(addFeature);
                }
                function addFeature(feature){
                    // placesService = new google.maps.places.PlacesService(map);
                    // placesService.getDetails({placeId: feature.googlePlaceId}, function(placeResult, placesServiceStatus){
                    //     latLng = placeResult.geometry.location;
                    // });
                    var latLng = new google.maps.LatLng(Number(feature.latitude), Number(feature.longitude));
                    var newMarker = new google.maps.Marker({
                        position: latLng,
                        map: gmap
                    });

                    var contentString = '<div id="content infoBitch">'
                                        + '<p>' + feature.description + '</p>'
                                        + '<img src ="https://storage.googleapis.com/krk_ornaments/' + feature.photoList[0].blobName
                                        + '" width = "80%" height="80%"/>'
                                        + '</div>';

                    var infowindow = new google.maps.InfoWindow({
                        content: contentString,
                        maxWidth: 300
                    });

                    newMarker.addListener('mouseover', function () {
                        infowindow.open(gmap, newMarker);
                    });
                    newMarker.addListener('mouseout', function () {
                        infowindow.close();
                    });
                }

                function initMap() {
                    gmap = new google.maps.Map(document.getElementById('map'), {
                        center: latlong,
                        zoom: 13
                    });
                    loadInitialFeatures();
                   // placeService = new google.maps.places.PlacesService(gmap);
                    geocoder = new google.maps.Geocoder;
                    // marker1 = new google.maps.Marker({
                    //     position: latlong,
                    //     map: gmap
                    // });
                    addressoWindow = new google.maps.InfoWindow({
                        content: addressoText
                    });
                    google.maps.event.addListener(gmap, 'click', function(event) {
                        if(currMarker != null){
                            currMarker.setMap(null);
                        }
                        currMarker = new google.maps.Marker({
                            position: event.latLng,
                            map: gmap
                        });


                        //google.maps.event.addListener(currMarker, 'click', function() {
                            //infowindow.open(gmap, marker);

                        geocoder.geocode({'location': event.latLng}, function(results,status){
                            var filteredResults = results.filter(x => x.types[0] === "street_address");
                            if(status === 'OK' && filteredResults.length > 0) {
                                var chosenResult = filteredResults[0];
                                $('[name="googlePlaceId"]').get(0).value = chosenResult.place_id;
                                $('[name="latitude"]').get(0).value = chosenResult.geometry.location.lat();
                                $('[name="longitude"]').get(0).value = chosenResult.geometry.location.lng();
                                $('label.address').text(chosenResult.formatted_address);
                                addressoWindow.setContent(chosenResult.formatted_address);
                            // });
                            }else{
                                $('label.address').text(noPlaceSelected);
                            }
                                //console.log(results[0].types);
                                // console.log(results[0].geometry.location.lat() + ", " + results[0].geometry.location.lng() + " : "
                                //     + results[0].place_id + " : " +  results[0].formatted_address);
                            }
                        );
                        currMarker.addListener('mouseover', function(){
                            addressoWindow.open(gmap, currMarker);
                        });
                        currMarker.addListener('mouseout', function(){
                            addressoWindow.close();
                        });
                        //});
                    });
                }
            </script>
            <!-- The script below has the unnecassary "&libraries=places" url-parameter that isn't needed if we aren't using
                 the places library -->
            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-7iMFFPCNY0gidSz6K7WUJsrj5uaWnJI&callback=initMap&libraries=places" async defer></script>
        </div>
    </body>
</html>